---
output: pdf_document
classoption: landscape
params:
    title: "Grouped Disease Surveillance Report"
    report_year: 2025
    report_month: 1
    report_data: NULL
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
---

<!-- grouped_report.Rmd is a template R Markdown document used for generating a PDF report with diseases grouped into categories -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r table, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
library(kableExtra)

r_data <- params$report_data
r_data <- r_data[order(r_data$Group, r_data$Disease), ]

r_year <- params$report_year
r_month <- params$report_month
r_month_abb <- month.abb[r_month]

if (length(names(r_data)) == 10) {
    # Set header row from input parameters
    # This workaround is needed to dynamically create the header names
    header_2 <- c(2, 2, 1)
    names(header_2) <- c(paste(r_month_abb, r_year), paste("Historical", r_month_abb), paste(r_year, "YTD"))
    header_2 <- c(" ", header_2, "Historical YTD" = 2, " ")

    # Build the table
    kbl(
        r_data[,2:10],
        row.names = FALSE,
        col.names = c("Disease", "Cases", "Rate", "Avg", "Median", "Cases", "Avg", "Median", "Trend"),
        booktabs = TRUE,
        longtable = TRUE,
        caption = params$title,
        align = "lcccccccl"
        ) |>
        add_header_above(header_2) |>
        kable_styling(
            font_size = 7,
            latex_options = c("scale_down", "repeat_header")
        ) |>
        column_spec(
            9,
            background = ifelse(
                r_data$`YTD Trend` == "Elevated", "red",
                ifelse(r_data$`YTD Trend` == "Expected", "yellow",
                "green"))
        ) |>
        pack_rows(
            index = table(r_data$Group),
            latex_gap_space = "1em"
        )
        
}
```


